pipeline {
    agent any

    environment {
        BACKEND_DIR = 'TLL_backend'
        FRONTEND_DIR = 'TLL_frontend'
        DOCKER_IMAGE_TAG = "${env.CHANGE_ID ?: env.BRANCH_NAME ?: 'latest'}"
        BUILD_BACKEND = 'false'
        BUILD_FRONTEND = 'false'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
                script {
                    sh 'git log -1 --oneline'
                    sh 'echo "Current branch: $(git branch --show-current)"'
                    sh 'echo "CHANGE_ID: ${CHANGE_ID}"'
                    sh 'echo "CHANGE_TARGET: ${CHANGE_TARGET}"'
                }
            }
        }

        stage('Detect Changes') {
            steps {
                script {
                    // Check if backend has changes
                    def backendStatus = sh(
                        script: """
                            if [ ! -d "${BACKEND_DIR}" ]; then
                                exit 1
                            fi
                            
                            if [ -z "\${CHANGE_ID}" ]; then
                                # Not a PR, build everything
                                exit 0
                            fi
                            
                            # For PR: fetch target branch and compare with merge-base
                            git fetch origin \${CHANGE_TARGET}
                            MERGE_BASE=\$(git merge-base HEAD origin/\${CHANGE_TARGET})
                            git diff --name-only \${MERGE_BASE}...HEAD | grep -q "^${BACKEND_DIR}/"
                        """,
                        returnStatus: true
                    )
                    
                    // Check if frontend has changes
                    def frontendStatus = sh(
                        script: """
                            if [ ! -d "${FRONTEND_DIR}" ]; then
                                exit 1
                            fi
                            
                            if [ -z "\${CHANGE_ID}" ]; then
                                # Not a PR, build everything
                                exit 0
                            fi
                            
                            # For PR: fetch target branch and compare with merge-base
                            git fetch origin \${CHANGE_TARGET}
                            MERGE_BASE=\$(git merge-base HEAD origin/\${CHANGE_TARGET})
                            git diff --name-only \${MERGE_BASE}...HEAD | grep -q "^${FRONTEND_DIR}/"
                        """,
                        returnStatus: true
                    )
                    
                    // Convert status codes to boolean strings
                    // Status 0 = success (changes found or no PR), non-zero = no changes
                    env.BUILD_BACKEND = (backendStatus == 0) ? 'true' : 'false'
                    env.BUILD_FRONTEND = (frontendStatus == 0) ? 'true' : 'false'
                    
                    echo "Build Backend: ${env.BUILD_BACKEND}"
                    echo "Build Frontend: ${env.BUILD_FRONTEND}"
                }
            }
        }

        stage('Build Backend Docker Image') {
            when {
                expression { env.BUILD_BACKEND == 'true' }
            }
            steps {
                dir(env.BACKEND_DIR) {
                    script {
                        echo "Building backend Docker image..."
                        sh """
                            docker build -t tll-backend:${env.DOCKER_IMAGE_TAG} .
                            docker tag tll-backend:${env.DOCKER_IMAGE_TAG} tll-backend:latest
                        """
                        echo "Backend image built: tll-backend:${env.DOCKER_IMAGE_TAG}"
                    }
                }
            }
        }

        stage('Build Frontend Docker Image') {
            when {
                expression { env.BUILD_FRONTEND == 'true' }
            }
            steps {
                dir(env.FRONTEND_DIR) {
                    script {
                        echo "Building frontend Docker image..."
                        sh """
                            docker build -t tll-frontend:${env.DOCKER_IMAGE_TAG} .
                            docker tag tll-frontend:${env.DOCKER_IMAGE_TAG} tll-frontend:latest
                        """
                        echo "Frontend image built: tll-frontend:${env.DOCKER_IMAGE_TAG}"
                    }
                }
            }
        }
    }

    post {
        success {
            script {
                def built = []
                if (env.BUILD_BACKEND == 'true') built.add('Backend')
                if (env.BUILD_FRONTEND == 'true') built.add('Frontend')
                
                if (built.size() > 0) {
                    echo "Build completed: ${built.join(', ')}"
                } else {
                    echo "No changes detected"
                }
            }
        }
        failure {
            echo "Build failed!"
        }
        always {
            sh 'docker system prune -f || true'
        }
    }
}
